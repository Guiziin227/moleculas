<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizador AR de Mol√©culas - Vers√£o Simples</title>

    <!-- A-Frame + AR.js (alternativa mais simples ao MindAR) -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
      }

      #loadingScreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        text-align: center;
        padding: 20px;
      }

      #loadingScreen.hidden {
        display: none;
      }

      .button {
        color: white;
        padding: 15px 30px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px;
        font-size: 16px;
        font-weight: bold;
      }

      #startButton {
        background: #4caf50;
      }

      #startButton:hover {
        background: #45a049;
      }

      select {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-size: 16px;
        min-width: 250px;
      }

      #instructions {
        background: rgba(255, 152, 0, 0.2);
        padding: 20px;
        border-radius: 10px;
        margin: 20px;
        max-width: 400px;
      }

      .arjs-loader {
        height: 100%;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9998;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .arjs-loader div {
        text-align: center;
        font-size: 1.25em;
        color: white;
      }
    </style>
  </head>
  <body>
    <!-- Tela de carregamento -->
    <div id="loadingScreen">
      <h1>üß¨ Visualizador AR de Mol√©culas</h1>

      <div id="instructions">
        <h3>üì± Como usar:</h3>
        <p>1. Selecione uma mol√©cula abaixo</p>
        <p>2. Clique em "Iniciar AR"</p>
        <p>3. Permita acesso √† c√¢mera</p>
        <p>4. Aponte para uma superf√≠cie</p>
        <p>5. Toque na tela para posicionar a mol√©cula</p>
      </div>

      <select id="moleculeSelect">
        <option value="">Selecione uma mol√©cula...</option>
        <option value="./pdb/methanol.pdb">Metanol</option>
        <option value="./pdb/ethanol.pdb">Etanol</option>
        <option value="./pdb/propanol.pdb">Propanol</option>
        <option value="./pdb/butanol.pdb">Butanol</option>
        <option value="./pdb/atp.pdb">ATP</option>
        <option value="./pdb/diamond.pdb">Diamante</option>
        <option value="./pdb/nacl.pdb">NaCl</option>
        <option value="./pdb/heroin.pdb">Hero√≠na</option>
      </select>

      <button id="startButton" class="button">üöÄ Iniciar AR</button>

      <p style="color: #888; font-size: 12px; margin-top: 20px;">
        Toque na tela para posicionar a mol√©cula onde voc√™ tocar
      </p>
    </div>

    <!-- Cena A-Frame com AR.js -->
    <a-scene
      id="arScene"
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
      vr-mode-ui="enabled: false"
      renderer="logarithmicDepthBuffer: true; precision: medium;"
    >
      <!-- C√¢mera -->
      <a-camera gps-camera rotation-reader></a-camera>

      <!-- Container para a mol√©cula -->
      <a-entity id="moleculeContainer" visible="false">
        <!-- A mol√©cula ser√° adicionada aqui dinamicamente -->
      </a-entity>
    </a-scene>

    <!-- Scripts -->
    <script src="./js/pdbParser.js"></script>

    <script>
      let moleculeData = null;
      let moleculeName = null;
      let moleculeEntity = null;
      let isPlaced = false;

      // Fun√ß√£o para carregar PDB
      async function loadPDB(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.text();
      }

      // Fun√ß√£o para criar mol√©cula em A-Frame
      function createMoleculeAFrame(atoms, connections) {
        const container = document.getElementById('moleculeContainer');

        // Limpar conte√∫do anterior
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }

        // Calcular centro e escala
        let minX = Infinity, maxX = -Infinity;
        let minY = Infinity, maxY = -Infinity;
        let minZ = Infinity, maxZ = -Infinity;

        atoms.forEach(atom => {
          minX = Math.min(minX, atom.x);
          maxX = Math.max(maxX, atom.x);
          minY = Math.min(minY, atom.y);
          maxY = Math.max(maxY, atom.y);
          minZ = Math.min(minZ, atom.z);
          maxZ = Math.max(maxZ, atom.z);
        });

        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;
        const centerZ = (minZ + maxZ) / 2;
        const maxSize = Math.max(maxX - minX, maxY - minY, maxZ - minZ);
        const scale = 0.05 / maxSize; // Escala para AR

        // Cores CPK
        const colors = {
          H: '#FFFFFF', C: '#000000', N: '#3050F8', O: '#FF0D0D',
          P: '#FF8000', S: '#FFFF30', Cl: '#1FF01F', F: '#90E050',
          Br: '#A62929', I: '#940094', Na: '#AB5CF2', K: '#8F40D4',
          Ca: '#3DFF00', Mg: '#8AFF00', Fe: '#E06633', Zn: '#7D80B0'
        };

        const radii = {
          H: 0.31, C: 0.76, N: 0.71, O: 0.66, P: 1.07, S: 1.05,
          Cl: 1.02, F: 0.57, Br: 1.2, I: 1.39, Na: 1.0, K: 1.2,
          Ca: 1.0, Mg: 0.9, Fe: 0.8, Zn: 0.75
        };

        // Criar √°tomos
        atoms.forEach(atom => {
          const sphere = document.createElement('a-sphere');
          const x = (atom.x - centerX) * scale;
          const y = (atom.y - centerY) * scale;
          const z = (atom.z - centerZ) * scale;
          const radius = (radii[atom.element] || 0.7) * scale;
          const color = colors[atom.element] || '#909090';

          sphere.setAttribute('position', `${x} ${y} ${z}`);
          sphere.setAttribute('radius', radius);
          sphere.setAttribute('color', color);
          sphere.setAttribute('metalness', '0.3');
          sphere.setAttribute('roughness', '0.7');

          container.appendChild(sphere);
        });

        // Criar liga√ß√µes
        connections.forEach(conn => {
          const atom1 = atoms.find(a => a.id === conn.atom1);
          const atom2 = atoms.find(a => a.id === conn.atom2);

          if (atom1 && atom2) {
            const x1 = (atom1.x - centerX) * scale;
            const y1 = (atom1.y - centerY) * scale;
            const z1 = (atom1.z - centerZ) * scale;
            const x2 = (atom2.x - centerX) * scale;
            const y2 = (atom2.y - centerY) * scale;
            const z2 = (atom2.z - centerZ) * scale;

            const dx = x2 - x1;
            const dy = y2 - y1;
            const dz = z2 - z1;
            const length = Math.sqrt(dx*dx + dy*dy + dz*dz);

            const cylinder = document.createElement('a-cylinder');
            cylinder.setAttribute('position', `${(x1+x2)/2} ${(y1+y2)/2} ${(z1+z2)/2}`);
            cylinder.setAttribute('height', length);
            cylinder.setAttribute('radius', 0.02 * scale);
            cylinder.setAttribute('color', '#CCCCCC');

            // Rota√ß√£o para alinhar o cilindro
            const rotation = new THREE.Euler();
            const direction = new THREE.Vector3(dx, dy, dz).normalize();
            const quaternion = new THREE.Quaternion();
            quaternion.setFromUnitVectors(new THREE.Vector3(0, 1, 0), direction);
            rotation.setFromQuaternion(quaternion);

            cylinder.setAttribute('rotation', `${rotation.x * 180/Math.PI} ${rotation.y * 180/Math.PI} ${rotation.z * 180/Math.PI}`);

            container.appendChild(cylinder);
          }
        });

        // Adicionar anima√ß√£o de rota√ß√£o
        container.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');
      }

      // Evento de toque/clique na tela
      let scene = document.querySelector('a-scene');
      scene.addEventListener('click', function(event) {
        if (!moleculeData || isPlaced) return;

        const container = document.getElementById('moleculeContainer');

        // Posicionar na frente da c√¢mera
        const camera = document.querySelector('a-camera');
        const cameraPos = camera.object3D.position;
        const cameraRot = camera.object3D.rotation;

        // Calcular posi√ß√£o 1 metro na frente da c√¢mera
        const distance = 1;
        const x = cameraPos.x - Math.sin(cameraRot.y) * distance;
        const y = cameraPos.y - 0.5; // Um pouco abaixo do n√≠vel dos olhos
        const z = cameraPos.z - Math.cos(cameraRot.y) * distance;

        container.setAttribute('position', `${x} ${y} ${z}`);
        container.setAttribute('visible', 'true');
        isPlaced = true;

        console.log('‚úÖ Mol√©cula posicionada em AR!');
      });

      // Iniciar AR
      document.getElementById('startButton').addEventListener('click', async () => {
        const select = document.getElementById('moleculeSelect');
        const url = select.value;

        if (!url) {
          alert('Por favor, selecione uma mol√©cula!');
          return;
        }

        try {
          // Carregar e parsear PDB
          const pdbText = await loadPDB(url);
          const { atoms, connections } = parsePDB(pdbText);

          moleculeData = { atoms, connections };
          moleculeName = select.options[select.selectedIndex].text;

          // Criar mol√©cula
          createMoleculeAFrame(atoms, connections);

          // Esconder tela de loading
          document.getElementById('loadingScreen').classList.add('hidden');

          console.log('‚úÖ AR iniciado! Toque na tela para posicionar a mol√©cula.');
        } catch (error) {
          console.error('‚ùå Erro:', error);
          alert('Erro ao carregar mol√©cula: ' + error.message);
        }
      });
    </script>
  </body>
</html>


